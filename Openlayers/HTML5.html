
<html>
<head>
  <title>Prosjektoppgave (NMBU, Skispor)</title>
  <meta content="text/html;charset=utf-8" http-equiv=Content-Type>
  <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
  <script src="http://openlayers.org/api/2.11/OpenLayers.js"></script>
  <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>

  <script type="text/javascript">
    
var kart, simuleringLayer, skisporLayer, OLLayer, FKBLayer, Orto, bevegelse;
var lat=59.660, lon=10.770;


function errorLowAccuracy(error) {
  document.getElementById('message3').innerHTML = "Message 3: Posisjonsfeil: Kode " + error.code +": " + error.message
  //alert("No position");
} // errorLowAccuracy

function errorHighAccuracy(error) {
  if (error.code == error.TIMEOUT) {
    test = navigator.geolocation.getCurrentPosition(okPosition, errorLowAccuracy,{timeout:2000, enableHighAccuracy: false});
  }
  else {
    document.getElementById('message3').innerHTML = "Message 3: Posisjonsfeil: Kode " + error.code +": " + error.message
    //alert("No position");
  }
} // errorHighAccuracy

function okPosition(position) {
  //alert("Koordinater: "+position.coords.latitude+", "+position.coords.longitude+" - "+position.coords.accuracy);
  lat = position.coords.latitude;
  lon = position.coords.longitude;
  acc = position.coords.accuracy;
  document.getElementById('message4').innerHTML = "Din posisjon er funnet til: ("+lon+", "+lat+")"+" - "+acc
  sted = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(lon, lat));
  stedLayer.addFeatures(sted);
  apprdiff = acc/111000;
  accbox = new OpenLayers.Feature.Vector(new OpenLayers.Bounds(lon-apprdiff,lat-apprdiff,lon+apprdiff,lat+apprdiff).toGeometry());
  accuracyLayer.addFeatures(accbox);
  if (kart) {
    kart.moveTo(new OpenLayers.LonLat(lon,lat),15);
  }
} // okPosition

function init(){
  // We need to check if the browser has the correct capabilities.
  if (navigator.geolocation) {
    document.getElementById('message1').innerHTML = "Prøver å finne din posisjon."
    //alert("navigator support!");
  } else {
    document.getElementById('message1').innerHTML = "Det var ikkje mogleg å finne din posisjon."
    //alert("no navigator support!");
  } // if else geolocation

  kart = new OpenLayers.Map('kart');
  skisporLayer = new OpenLayers.Layer.WMS("Skispor-kart WMS"
  , "http://localhost/cgi-bin/mapserv.exe?map=C:/Users/landsat4/Documents/GMGI300/Mapserver/wmstjeneste_loype.map&SERVICE=WMS"
  , {layers: 'punkt', transparent: 'true'}
  , {singleTile: true, ratio: 1, isBaseLayer: false} );
  
  simuleringLayer = new OpenLayers.Layer.WMS("Skispor dynamisk simulering"
  , "http://localhost/cgi-bin/mapserv.exe?map=C:/Users/landsat4/Documents/GMGI300/Mapserver/wmstjeneste_simulering.map&SERVICE=WMS"
  , {layers: 'simulering', transparent: 'true'}
  , {singleTile: true, ratio: 1, isBaseLayer: false} );

  FKBLayer = new OpenLayers.Layer.WMS( "Norges grunnkart"
  , "http://openwms.statkart.no/skwms1/wms.norges_grunnkart?"
  , {layers: 'norges_grunnkart', isBaseLayer: true});

  stedLayer = new OpenLayers.Layer.Vector("Kor er du?");
  accuracyLayer = new OpenLayers.Layer.Vector("Nøyaktighet");
  OLLayer = new OpenLayers.Layer.WMS( "VMap0 - OpenLayers WMS"
  , "http://vmap0.tiles.osgeo.org/wms/vmap0"
  , {layers: 'basic', transparent: 'true'}
  , {singleTile: true, ratio: 1.2, isBaseLayer: true} );

  Orto = new OpenLayers.Layer.WMS("Ortobilde", " http://wms.geonorge.no/skwms1/wms.nib?", {layers: 'ortofoto', isBaseLayer: true});
 
  kart.addLayer(FKBLayer);
  kart.addLayer(OLLayer);
  kart.addLayer(stedLayer);
  kart.addLayer(accuracyLayer);
  kart.addLayer(skisporLayer);
  kart.addLayer(simuleringLayer);
  kart.addLayer(Orto);
  kart.moveTo(new OpenLayers.LonLat(lon,lat),6);
  kart.moveTo(new OpenLayers.LonLat(10,60),6);
  kart.addControl(new OpenLayers.Control.LayerSwitcher());

  // Med Firefox i Ubuntu LTS fungerer ikke dette!
  if (navigator.geolocation) {
    test = navigator.geolocation.getCurrentPosition(okPosition, errorHighAccuracy,{timeout:2000, enableHighAccuracy: true});
    alert("getcurrentpos finished"+test)
    if (kart) {
      kart.moveTo(new OpenLayers.LonLat(lon,lat),6);
    }
  } // if else geolocation

} // init

var da = new Date()-new Date(2011, 3, 3)
var ar = Math.floor(da/31536000000)
var month = Math.round(((da/31536000000)-ar)*12)
var tid = ("Det er "+ar + " år og ca "+month+" månader sidan preppemaskinen sist kjørte.")

</script>

<style>
.minikart {
width: 100%;
height: 500px;
border: 1px solid #cc6;
}
</style>
</head>
<body onload="init()">

  <?php
if ($_GET['run']) {
  // This code will run if ?run=true is set.
  exec(open("python simulering.py").read());
}
?>

<!-- This link will add ?run=true to your URL, myfilename.php?run=true -->
<h1 id="title">Prosjektoppgave GMGI300</h1>
<h3 id="title">Annette Primstad og Jon Hidle Pedersen</h3>
Du kan velge å tillate lesing av din posisjon, for å vise sted og tilnærmet nøyaktighet.
<div id="message1"></div>
<div id="message2"></div>
<div id="message3"></div>
<div id="message4"></div>
<div id="kart" class="minikart"></div>
<div id="docs"> 
<button type="button" onclick="alert(tid)">Korti kjørte preppemaskinen sist</button>

<p>Koordinatsystem: WGS1984, ikke-projisert (lengdegrader-breddegrader).</p>
</div>
<form action="http://pythontutor.com/visualize.html#mode=edit" method="POST">
<button name="name" value="value">Python tutor</button>
</form>
</body>
</html>
